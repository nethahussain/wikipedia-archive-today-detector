<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Archive.today Link Detector ‚Äî Wikipedia Reference Audit</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,600;8..60,700&family=Inter:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
body{background:#FAF9F5;color:#141413;font-family:'Inter',-apple-system,sans-serif}
@keyframes _sp{to{transform:rotate(360deg)}}
@keyframes _fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
@keyframes _copyFlash{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
::selection{background:rgba(217,119,87,0.2)}
*::-webkit-scrollbar{width:6px}*::-webkit-scrollbar-track{background:transparent}*::-webkit-scrollbar-thumb{background:#D5D4CE;border-radius:3px}
input:focus,textarea:focus{outline:none;border-color:#D97757!important;box-shadow:0 0 0 3px rgba(217,119,87,0.12)!important}
button{transition:all 0.15s ease}a{transition:color 0.15s ease}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useCallback,useRef,useEffect}=React;

const AT_DOMAINS=["archive.today","archive.ph","archive.is","archive.fo","archive.li","archive.vn","archive.md"];
const AT_RE=new RegExp(`https?:\\/\\/(?:${AT_DOMAINS.map(d=>d.replace(/\./g,"\\.")).join("|")})\\/[^\\s\\]|}<>"]*`,"gi");
const TOPICS=[
{id:"medicine",label:"Medicine",icon:"ü©∫",cats:["Category:Medicine","Category:Diseases and disorders","Category:Medical treatments","Category:Drugs","Category:Epidemiology","Category:Pathology","Category:Medical specialties","Category:Public health","Category:Radiology","Category:Surgery","Category:Pharmacology","Category:Vaccines","Category:Cardiology","Category:Oncology","Category:Neurology","Category:Pediatrics","Category:Psychiatry","Category:Obstetrics","Category:Gynecology","Category:Dermatology","Category:Ophthalmology","Category:Emergency medicine","Category:Infectious diseases","Category:Gastroenterology","Category:Endocrinology","Category:Nephrology","Category:Pulmonology","Category:Hematology","Category:Rheumatology","Category:Urology","Category:Orthopedic surgery","Category:Anesthesiology","Category:Geriatrics","Category:Immunology","Category:Tropical diseases","Category:Palliative care","Category:Medical genetics","Category:Health informatics"]},
{id:"biology",label:"Biology",icon:"üß¨",cats:["Category:Biology","Category:Genetics","Category:Molecular biology","Category:Microbiology","Category:Ecology","Category:Botany","Category:Zoology","Category:Cell biology","Category:Evolutionary biology","Category:Marine biology","Category:Neuroscience","Category:Developmental biology","Category:Biochemistry","Category:Biophysics","Category:Taxonomy (biology)","Category:Mycology","Category:Virology","Category:Parasitology","Category:Ethology","Category:Conservation biology","Category:Entomology","Category:Ornithology","Category:Mammals","Category:Reptiles","Category:Amphibians","Category:Fish","Category:Plants","Category:Fungi","Category:Bacteria","Category:Paleontology"]},
{id:"physics",label:"Physics",icon:"‚öõÔ∏è",cats:["Category:Physics","Category:Quantum mechanics","Category:Astrophysics","Category:Particle physics","Category:Nuclear physics","Category:Condensed matter physics","Category:Thermodynamics","Category:Optics","Category:Electromagnetism","Category:Classical mechanics","Category:Relativity","Category:Cosmology","Category:Plasma physics","Category:Acoustics","Category:Fluid dynamics","Category:Solid-state physics","Category:Atomic physics","Category:Physical constants","Category:Physics experiments","Category:Physicists"]},
{id:"chemistry",label:"Chemistry",icon:"üß™",cats:["Category:Chemistry","Category:Chemical elements","Category:Organic chemistry","Category:Biochemistry","Category:Chemical compounds","Category:Inorganic chemistry","Category:Physical chemistry","Category:Analytical chemistry","Category:Polymer chemistry","Category:Medicinal chemistry","Category:Environmental chemistry","Category:Electrochemistry","Category:Nuclear chemistry","Category:Chemical reactions","Category:Chemical processes","Category:Materials science","Category:Nanotechnology","Category:Crystallography","Category:Chemists","Category:Chemical engineering"]},
{id:"cs",label:"Computer Science",icon:"üíª",cats:["Category:Computer science","Category:Artificial intelligence","Category:Machine learning","Category:Programming languages","Category:Cryptography","Category:Software","Category:Algorithms","Category:Data structures","Category:Computer networking","Category:Computer security","Category:Databases","Category:Operating systems","Category:Computer architecture","Category:Distributed computing","Category:Computer graphics","Category:Natural language processing","Category:Robotics","Category:Information theory","Category:Computational complexity theory","Category:Computer vision","Category:Human‚Äìcomputer interaction","Category:Software engineering","Category:Web development","Category:Cloud computing","Category:Internet","Category:Computer hardware"]},
{id:"history",label:"History",icon:"üìú",cats:["Category:History","Category:Ancient history","Category:Medieval history","Category:Modern history","Category:World War II","Category:World War I","Category:History of science","Category:Historiography","Category:Military history","Category:History of Asia","Category:History of Europe","Category:History of Africa","Category:History of the Americas","Category:Cold War","Category:Colonialism","Category:Decolonization","Category:Revolutions","Category:History of religion","Category:Industrial Revolution","Category:Ancient Rome","Category:Ancient Greece","Category:Byzantine Empire","Category:Ottoman Empire","Category:British Empire","Category:Mongol Empire","Category:History of China","Category:History of India","Category:History of the Middle East","Category:Archaeological sites","Category:Historical documents"]},
{id:"politics",label:"Politics",icon:"üèõÔ∏è",cats:["Category:Politics","Category:Elections","Category:Political parties","Category:Heads of state","Category:International relations","Category:Diplomacy","Category:Democracy","Category:Political ideologies","Category:Political movements","Category:Legislatures","Category:Political scandals","Category:Constitutions","Category:Political campaigns","Category:Referendums","Category:Government agencies","Category:United Nations","Category:European Union","Category:NATO","Category:Geopolitics","Category:Civil rights movements","Category:Political philosophy","Category:Nationalism","Category:Socialism","Category:Conservatism","Category:Liberalism","Category:Anarchism","Category:Terrorism","Category:Espionage","Category:Intelligence agencies"]},
{id:"geography",label:"Geography",icon:"üåç",cats:["Category:Geography","Category:Countries","Category:Cities","Category:Islands","Category:Rivers","Category:Mountains","Category:Deserts","Category:Oceans","Category:Lakes","Category:Continents","Category:Capitals","Category:Peninsulas","Category:Valleys","Category:Glaciers","Category:Volcanoes","Category:Earthquakes","Category:National parks","Category:Forests","Category:Wetlands","Category:Caves","Category:Archipelagoes","Category:Straits","Category:Bays","Category:Capes","Category:Plateaus","Category:Plains","Category:UNESCO World Heritage Sites"]},
{id:"law",label:"Law",icon:"‚öñÔ∏è",cats:["Category:Law","Category:Criminal law","Category:International law","Category:Human rights","Category:Supreme Court of the United States","Category:Constitutional law","Category:Contract law","Category:Property law","Category:Family law","Category:Labour law","Category:Tax law","Category:Environmental law","Category:Intellectual property law","Category:Tort law","Category:Evidence law","Category:War crimes","Category:Genocide","Category:International criminal law","Category:Legal history","Category:Legal systems","Category:Judges","Category:Courts","Category:Law enforcement","Category:Prisons","Category:Capital punishment","Category:Civil liberties"]},
{id:"economics",label:"Economics",icon:"üìä",cats:["Category:Economics","Category:Macroeconomics","Category:Microeconomics","Category:Finance","Category:Monetary policy","Category:International trade","Category:Banking","Category:Stock exchanges","Category:Currencies","Category:Economic history","Category:Economic systems","Category:Capitalism","Category:Market economy","Category:Economic inequality","Category:Poverty","Category:Inflation","Category:Unemployment","Category:Central banks","Category:Taxation","Category:Investment","Category:Corporations","Category:Economic crises","Category:Financial crises","Category:Cryptocurrency","Category:Development economics"]},
{id:"engineering",label:"Engineering",icon:"üîß",cats:["Category:Engineering","Category:Electrical engineering","Category:Civil engineering","Category:Mechanical engineering","Category:Aerospace engineering","Category:Chemical engineering","Category:Biomedical engineering","Category:Environmental engineering","Category:Nuclear engineering","Category:Structural engineering","Category:Transportation engineering","Category:Mining engineering","Category:Petroleum engineering","Category:Telecommunications engineering","Category:Industrial engineering","Category:Systems engineering","Category:Bridges","Category:Dams","Category:Tunnels","Category:Skyscrapers","Category:Power stations","Category:Spacecraft","Category:Aircraft","Category:Ships","Category:Automobiles","Category:Trains"]},
{id:"media",label:"Media & Journalism",icon:"üì∞",cats:["Category:Mass media","Category:Journalism","Category:Newspapers","Category:Television","Category:Radio","Category:Podcasts","Category:Magazines","Category:News agencies","Category:Broadcasting","Category:Advertising","Category:Public relations","Category:Film","Category:Documentary films","Category:Photography","Category:Publishing","Category:Censorship","Category:Freedom of the press","Category:Media companies","Category:Television networks","Category:Radio stations","Category:Social media","Category:Internet media","Category:Journalists","Category:Film directors","Category:Animation"]},
{id:"environment",label:"Environment",icon:"üå±",cats:["Category:Environmentalism","Category:Climate change","Category:Pollution","Category:Conservation","Category:Renewable energy","Category:Sustainability","Category:Biodiversity","Category:Deforestation","Category:Endangered species","Category:Extinction","Category:Natural disasters","Category:Floods","Category:Droughts","Category:Wildfires","Category:Air pollution","Category:Water pollution","Category:Waste management","Category:Recycling","Category:Solar energy","Category:Wind power","Category:Nuclear power","Category:Fossil fuels","Category:Carbon dioxide","Category:Ozone depletion","Category:Coral reefs","Category:Rainforests","Category:Environmental organizations","Category:Environmental law"]},
{id:"education",label:"Education",icon:"üéì",cats:["Category:Education","Category:Universities and colleges","Category:Schools","Category:Educational technology","Category:Academic disciplines","Category:Libraries","Category:Museums","Category:Scholarships","Category:Student organizations","Category:Literacy","Category:Special education","Category:Distance education","Category:Higher education","Category:Secondary education","Category:Primary education","Category:Vocational education","Category:Academic publishing","Category:Research institutes","Category:Think tanks","Category:Nobel laureates","Category:Academic conferences","Category:Scientific journals","Category:Learned societies"]},
{id:"sports",label:"Sports",icon:"‚öΩ",cats:["Category:Sports","Category:Olympic Games","Category:Football","Category:Cricket","Category:Basketball","Category:Tennis","Category:Athletics (sport)","Category:Swimming (sport)","Category:Cycling","Category:Boxing","Category:Martial arts","Category:Golf","Category:Rugby union","Category:Baseball","Category:Ice hockey","Category:Volleyball","Category:Handball","Category:Fencing","Category:Gymnastics","Category:Weightlifting","Category:Skiing","Category:Motorsport","Category:Horse racing","Category:Rowing (sport)","Category:Sailing","Category:Table tennis","Category:Badminton","Category:FIFA World Cup","Category:Commonwealth Games","Category:Asian Games"]},
];
const LANG="en";
const C={bg:"#FAF9F5",bgAlt:"#F0EEE6",card:"#FFFFFF",cardBorder:"#E8E6DE",text:"#141413",textSec:"#3D3D3A",muted:"#73726C",mutedLight:"#A3A29C",accent:"#D97757",accentHover:"#C4684B",accentSoft:"rgba(217,119,87,0.08)",accentBorder:"rgba(217,119,87,0.2)",green:"#2E7D5B",greenSoft:"rgba(46,125,91,0.08)",greenBorder:"rgba(46,125,91,0.2)",red:"#C4533A",redSoft:"rgba(196,83,58,0.08)",redBorder:"rgba(196,83,58,0.2)",amber:"#A67A2E",amberSoft:"rgba(166,122,46,0.08)",amberBorder:"rgba(166,122,46,0.2)",blue:"#3B6BA5",blueSoft:"rgba(59,107,165,0.06)",blueBorder:"rgba(59,107,165,0.18)",btnDark:"#3D3D3A",btnDarkHover:"#2A2A28",mono:"'IBM Plex Mono',monospace",serif:"'Source Serif 4',Georgia,serif",sans:"'Inter',-apple-system,sans-serif",radius:"12px",radiusSm:"8px",shadow:"0 1px 3px rgba(0,0,0,0.04),0 1px 2px rgba(0,0,0,0.02)",shadowMd:"0 4px 12px rgba(0,0,0,0.06),0 1px 3px rgba(0,0,0,0.04)"};

function extractOriginalUrl(archiveUrl, wikitext) {
  try {
    const u = new URL(archiveUrl), p = u.pathname + u.search;
    const m = p.match(/\/((?:\d{8,14}\/)?)(https?:\/\/.+)/);
    if (m && m[2]) return m[2];
  } catch(e) {}

  if (!wikitext) {
      console.warn("ABORT 1: Wikitext variable is missing for:", archiveUrl);
      return null;
  }

  const blockInfo = extractCitationBlock(wikitext, archiveUrl);
  if (!blockInfo || !blockInfo.text) {
      console.warn("ABORT 2: State Machine failed to isolate a citation for:", archiveUrl);
      return null;
  }

  const urlRegex = /\|\s*url\s*=\s*(https?:\/\/[^[\]|{}\s<>"]+)/i;
  const match = urlRegex.exec(blockInfo.text);
  
  if (!match || !match[1]) {
      console.warn("ABORT 3: Regex failed to find a valid |url= inside this block:", blockInfo.text);
      return null;
  }

  if (match[1].match(/archive\.(today|is|ph|fo|li|vn|md)/i) || match[1].match(/web\.archive\.org/i)) {
      console.warn("ABORT 4: The extracted URL was another archive link:", match[1]);
      return null;
  }

  return match[1]; // Success!
}

/* ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ */
function extractOriginalUrlOrignal(archiveUrl, wikitext) {
  // 1. Direct URL extraction (Catches standard long timestamps instantly)
  try {
    const u = new URL(archiveUrl), p = u.pathname + u.search;
    const m = p.match(/\/((?:\d{8,14}\/)?)(https?:\/\/.+)/);
    if (m && m[2]) return m[2];
  } catch(e) {}

  // 2. Wikitext extraction using State Machine (The Short Hash Fix)
  // If wikitext isn't passed, gracefully fall back to returning null
  if (!wikitext) return null;

  const blockInfo = extractCitationBlock(wikitext, archiveUrl);
  if (!blockInfo || !blockInfo.text) return null;

  // Now safely search ONLY inside the isolated citation block
  const urlRegex = /\|\s*url\s*=\s*(https?:\/\/[^[\]|{}\s<>"]+)/i;
  const match = urlRegex.exec(blockInfo.text);
  
  if (match && match[1]) {
     if (match[1].match(/archive\.(today|is|ph|fo|li|vn|md)/i)) return null;
     if (match[1].match(/web\.archive\.org/i)) return null;
     return match[1];
  }
  return null;
}


async function checkWayback(o,retries=3){
  for(let attempt=0;attempt<=retries;attempt++){
    try{
      const r=await fetch(`https://archive.org/wayback/available?url=${encodeURIComponent(o)}`);
      if(r.status===503&&attempt<retries){await new Promise(w=>setTimeout(w,1000*(attempt+1)));continue}
      if(!r.ok)return null;
      const d=await r.json();
      return d.archived_snapshots?.closest?.available?d.archived_snapshots.closest.url:null;
    }catch{if(attempt<retries){await new Promise(w=>setTimeout(w,1000*(attempt+1)));continue}return null}
  }
  return null;
}
async function fetchWikitext(t){const r=await fetch(`https://${LANG}.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(t)}&prop=wikitext&format=json&origin=*`);if(!r.ok)throw new Error(`API ${r.status}`);const d=await r.json();if(d.error)throw new Error(d.error.info);return d.parse.wikitext["*"]}
async function fetchCatMembers(c,limit=500){const prefix=c.startsWith("Category:")?c:`Category:${c}`;let a=[],cm="";const rndTs=new Date(Date.now()-Math.random()*(Date.now()-new Date("2003-01-01").getTime())).toISOString();const sortParam=`&cmsort=timestamp&cmstart=${rndTs}`;do{const u=`https://${LANG}.wikipedia.org/w/api.php?action=query&list=categorymembers&cmtitle=${encodeURIComponent(prefix)}&cmlimit=50&cmtype=page&cmnamespace=0&format=json&origin=*${sortParam}${cm?`&cmcontinue=${cm}`:""}`;const r=await fetch(u);const d=await r.json();if(d.query?.categorymembers)a.push(...d.query.categorymembers.map(m=>m.title));cm=d.continue?.cmcontinue||""}while(cm&&a.length<limit);if(a.length<limit){let cm2="";do{const u2=`https://${LANG}.wikipedia.org/w/api.php?action=query&list=categorymembers&cmtitle=${encodeURIComponent(prefix)}&cmlimit=50&cmtype=page&cmnamespace=0&format=json&origin=*&cmsort=timestamp&cmstart=2001-01-01T00:00:00Z&cmend=${rndTs}${cm2?`&cmcontinue=${cm2}`:""}`;const r2=await fetch(u2);const d2=await r2.json();if(d2.query?.categorymembers)a.push(...d2.query.categorymembers.filter(m=>!a.includes(m.title)).map(m=>m.title));cm2=d2.continue?.cmcontinue||""}while(cm2&&a.length<limit)}for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a.slice(0,limit)}

/* ‚îÄ‚îÄ Smart Citation Extractor (State Machine) ‚îÄ‚îÄ */
function extractCitationBlock(wikitext, targetUrl) {
  const idx = wikitext.indexOf(targetUrl);
  if (idx === -1) return { start: -1, end: -1, text: null };

  // 1. Walk backward to find the start of the citation template
  let startIdx = idx;
  let foundStart = false;
  while (startIdx >= 0 && (idx - startIdx) < 1500) {
    if (wikitext.substring(startIdx, startIdx + 2) === '{{') {
      const prefix = wikitext.substring(startIdx, startIdx + 12).toLowerCase();
      if (prefix.includes('cite') || prefix.includes('vcite') || prefix.includes('citation')) {
         foundStart = true;
         break;
      }
    }
    startIdx--;
  }
  if (!foundStart) return { start: -1, end: -1, text: null };

  // 2. Walk forward to find the exact end boundary
  let depth = 0;
  let endIdx = startIdx;
  const staticLimit = 4000;

  while (endIdx < wikitext.length) {
     if (endIdx - startIdx > staticLimit) return { start: -1, end: -1, text: null };
     if (wikitext.substring(endIdx, endIdx + 2) === '\n\n' || wikitext.substring(endIdx, endIdx + 3) === '\n==') {
         return { start: -1, end: -1, text: null };
     }
     
     if (wikitext.substring(endIdx, endIdx + 2) === '{{') {
         depth++;
         if (depth > 10) return { start: -1, end: -1, text: null }; // 10-level abort
         endIdx += 2;
         continue;
     }
     if (wikitext.substring(endIdx, endIdx + 2) === '}}') {
         depth--;
         endIdx += 2;
         // When depth hits 0, we have perfectly isolated the citation
         if (depth === 0) {
             return { start: startIdx, end: endIdx, text: wikitext.substring(startIdx, endIdx) };
         }
         continue;
     }
     endIdx++;
  }
  return { start: -1, end: -1, text: null };
}

/* ‚îÄ‚îÄ Extract date from Wayback URL ‚îÄ‚îÄ */
function extractWaybackDate(waybackUrl){
  if(!waybackUrl)return null;
  const m=waybackUrl.match(/\/web\/(\d{4})(\d{2})(\d{2})\d*/);
  if(!m)return null;
  return `${m[1]}-${m[2]}-${m[3]}`;
}


/* ‚îÄ‚îÄ Mass Edit Logic (Hidden POST Form) ‚îÄ‚îÄ */
const escapeRegExp = (str) => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

function executeMassEdit(title, originalWikitext, selectedLinks) {
  let newText = originalWikitext;
  let replacedCount = 0;

  selectedLinks.forEach(link => {
    if (link.archiveUrl && link.waybackUrl) {
      // Try the citation block approach first
      const blockInfo = extractCitationBlock(newText, link.archiveUrl);
      
      if (blockInfo.text && blockInfo.text.includes(link.archiveUrl)) {
         let updatedBlock = blockInfo.text;
         
         // 1. Swap the URL safely inside the isolated block
         updatedBlock = updatedBlock.split(link.archiveUrl).join(link.waybackUrl);
         
         // 2. Update or insert archive-date inside the isolated block
         //    Handles both |archive-date= and |archivedate= (alias)
         if (link.waybackDate) {
             const dateRegex = /(\|\s*archive-?date\s*=)[^|}]*/i;

             if (dateRegex.test(updatedBlock)) {
                 // Date parameter exists ‚Äî update its value
                 updatedBlock = updatedBlock.replace(dateRegex, `$1 ${link.waybackDate}`);
             } else {
                 // Date parameter missing ‚Äî insert after |archive-url= or |archiveurl=
                 const afterArchiveUrl = /(\|\s*archive-?url\s*=[^|}]*)/i;
                 if (afterArchiveUrl.test(updatedBlock)) {
                     updatedBlock = updatedBlock.replace(
                         afterArchiveUrl,
                         `$1 |archive-date=${link.waybackDate}`
                     );
                 }
             }
         }
         
         // 3. Stitch the article back together
         newText = newText.substring(0, blockInfo.start) + updatedBlock + newText.substring(blockInfo.end);
         replacedCount++;
      } else {
         // Fallback: simple string replacement anywhere in the wikitext
         const before = newText;
         newText = newText.split(link.archiveUrl).join(link.waybackUrl);
         if (newText !== before) {
           replacedCount++;
           // Also try to insert archive-date after archive-url in the surrounding context
           if (link.waybackDate) {
             const dateRegex = /(\|\s*archive-?date\s*=)[^|}]*/i;
             if (!dateRegex.test(newText)) {
               const afterArchiveUrl = /(\|\s*archive-?url\s*=[^|}]*)/i;
               if (afterArchiveUrl.test(newText)) {
                 newText = newText.replace(
                   afterArchiveUrl,
                   `$1 |archive-date=${link.waybackDate}`
                 );
               }
             }
           }
         }
      }
    }
  });

  if (replacedCount === 0 || newText === originalWikitext) {
    alert("No changes could be made. The article may have been edited since scanning. Try re-scanning the article.");
    return;
  }

  const summary = `Replacing ${replacedCount} archive.today link${replacedCount > 1 ? 's' : ''} with Wayback Machine alternative${replacedCount > 1 ? 's' : ''} per [[WP:ATODAY]] (via [https://github.com/nethahussain/wikipedia-archive-today-detector AT Detector])`;

  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `https://en.wikipedia.org/w/index.php?title=${encodeURIComponent(title)}&action=submit`;
  form.target = '_blank';

  const tbInput = document.createElement('input');
  tbInput.type = 'hidden';
  tbInput.name = 'wpTextbox1';
  tbInput.value = newText;
  form.appendChild(tbInput);

  const summaryInput = document.createElement('input');
  summaryInput.type = 'hidden';
  summaryInput.name = 'wpSummary';
  summaryInput.value = summary;
  form.appendChild(summaryInput);

  const diffInput = document.createElement('input');
  diffInput.type = 'hidden';
  diffInput.name = 'wpDiff';
  diffInput.value = 'Show changes';
  form.appendChild(diffInput);

  // --- NEW: Anti-truncation dummy field (Silences the server warning) ---
  const ultimateInput = document.createElement('input');
  ultimateInput.type = 'hidden';
  ultimateInput.name = 'wpUltimateParam';
  ultimateInput.value = '1';
  form.appendChild(ultimateInput);

  // --- NEW: Dummy edit token (Satisfies MW's preview security check) ---
  const tokenInput = document.createElement('input');
  tokenInput.type = 'hidden';
  tokenInput.name = 'wpEditToken';
  tokenInput.value = '+\\';
  form.appendChild(tokenInput);

  document.body.appendChild(form);
  form.submit();
  document.body.removeChild(form);
}

/* ‚îÄ‚îÄ Wikipedia search suggestions ‚îÄ‚îÄ */
async function searchArticles(query){
  if(!query||query.length<2)return[];
  try{const r=await fetch(`https://${LANG}.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(query)}&limit=8&namespace=0&format=json&origin=*`);
    const d=await r.json();return d[1]||[]}catch{return[]}
}
async function searchCategories(query){
  if(!query||query.length<2)return[];
  const q=query.replace(/^Category:/i,"");
  try{const r=await fetch(`https://${LANG}.wikipedia.org/w/api.php?action=opensearch&search=Category:${encodeURIComponent(q)}&limit=8&namespace=14&format=json&origin=*`);
    const d=await r.json();return d[1]||[]}catch{return[]}
}

/* ‚îÄ‚îÄ Fetch top viewed pages from Wikimedia Pageviews API ‚îÄ‚îÄ */
async function fetchTopPages(year, month) {
  const mm = String(month).padStart(2, '0');
  const url = `https://wikimedia.org/api/rest_v1/metrics/pageviews/top/en.wikipedia/all-access/${year}/${mm}/all-days`;

  const response = await fetch(url, {
    headers: { 'User-Agent': 'ArchiveTodayDetector/1.0 (https://github.com/nethahussain/wikipedia-archive-today-detector)' }
  });

  if (!response.ok) {
    throw new Error(`Pageviews API returned ${response.status}`);
  }

  const data = await response.json();
  const articles = data.items?.[0]?.articles || [];

  // Filter out non-article pages
  const skipPrefixes = [
    'Main_Page', 'Special:', 'Wikipedia:', 'Help:',
    'Portal:', 'File:', 'Template:', 'Category:', 'Talk:',
    'User:', 'MediaWiki:', 'Draft:', 'Module:'
  ];

  return articles
    .filter(a => !skipPrefixes.some(prefix => a.article.startsWith(prefix)))
    .filter(a => !a.article.startsWith('-'))
    .map(a => ({
      title: a.article.replace(/_/g, ' '),
      views: a.views
    }));
}

function buildEditUrl(title,links){
  const n=links.length;
  const summary=`Replacing ${n} archive.today link${n>1?'s':''} with Wayback Machine alternative${n>1?'s':''} per [[WP:ATODAY]]`;
  return `https://en.wikipedia.org/w/index.php?title=${encodeURIComponent(title)}&action=edit&summary=${encodeURIComponent(summary)}`;
}

/* ‚îÄ‚îÄ Autocomplete Input ‚îÄ‚îÄ */
function AutocompleteInput({placeholder,value,onChange,onGo,loading,onStop,searchFn,displayFn}){
  const[suggestions,setSuggestions]=useState([]);
  const[showDrop,setShowDrop]=useState(false);
  const[activeIdx,setActiveIdx]=useState(-1);
  const debounceRef=useRef(null);
  const wrapRef=useRef(null);

  useEffect(()=>{
    if(debounceRef.current)clearTimeout(debounceRef.current);
    if(!value||value.length<2){setSuggestions([]);return}
    debounceRef.current=setTimeout(async()=>{
      const results=await searchFn(value);
      setSuggestions(results);setShowDrop(results.length>0);setActiveIdx(-1);
    },250);
    return()=>{if(debounceRef.current)clearTimeout(debounceRef.current)};
  },[value]);

  useEffect(()=>{
    const handler=e=>{if(wrapRef.current&&!wrapRef.current.contains(e.target))setShowDrop(false)};
    document.addEventListener("mousedown",handler);return()=>document.removeEventListener("mousedown",handler);
  },[]);

  const selectItem=(item)=>{onChange(displayFn?displayFn(item):item);setShowDrop(false);setSuggestions([])};
  const handleKey=(e)=>{
    if(!showDrop||!suggestions.length){if(e.key==="Enter"&&!loading)onGo();return}
    if(e.key==="ArrowDown"){e.preventDefault();setActiveIdx(p=>Math.min(p+1,suggestions.length-1))}
    else if(e.key==="ArrowUp"){e.preventDefault();setActiveIdx(p=>Math.max(p-1,0))}
    else if(e.key==="Enter"){e.preventDefault();if(activeIdx>=0)selectItem(suggestions[activeIdx]);else{setShowDrop(false);if(!loading)onGo()}}
    else if(e.key==="Escape")setShowDrop(false);
  };

  return(
    <div style={{display:"flex",gap:10,marginBottom:16,flexWrap:"wrap"}} ref={wrapRef}>
      <div style={{flex:1,minWidth:220,position:"relative"}}>
        <input type="text" value={value} onChange={e=>{onChange(e.target.value);setShowDrop(true)}} onKeyDown={handleKey}
          onFocus={()=>{if(suggestions.length)setShowDrop(true)}}
          placeholder={placeholder}
          style={{width:"100%",padding:"12px 16px",borderRadius:C.radiusSm,border:`1px solid ${C.cardBorder}`,background:C.card,color:C.text,fontSize:14,fontFamily:C.sans,boxShadow:C.shadow}}/>
        {showDrop&&suggestions.length>0&&(
          <div style={{position:"absolute",top:"100%",left:0,right:0,zIndex:100,marginTop:4,background:C.card,border:`1px solid ${C.cardBorder}`,borderRadius:C.radiusSm,boxShadow:C.shadowMd,maxHeight:320,overflowY:"auto"}}>
            {suggestions.map((item,idx)=>{
              const label=displayFn?displayFn(item):item;
              return(
                <div key={label} onClick={()=>selectItem(item)}
                  onMouseEnter={()=>setActiveIdx(idx)}
                  style={{
                    padding:"10px 16px",cursor:"pointer",fontSize:13,fontFamily:C.sans,
                    color:idx===activeIdx?C.accent:C.text,
                    background:idx===activeIdx?C.accentSoft:"transparent",
                    borderBottom:idx<suggestions.length-1?`1px solid ${C.bgAlt}`:"none",
                  }}>
                  {label}
                </div>
              );
            })}
          </div>
        )}
      </div>
      <button onClick={loading?onStop:onGo} disabled={!value.trim()&&!loading}
        onMouseEnter={e=>{if(!loading)e.currentTarget.style.background=C.btnDarkHover}}
        onMouseLeave={e=>{if(!loading)e.currentTarget.style.background=C.btnDark}}
        style={{padding:"12px 28px",borderRadius:C.radiusSm,border:"none",background:loading?C.red:C.btnDark,color:"#FAF9F5",fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:C.sans,opacity:(!value.trim()&&!loading)?0.35:1,boxShadow:C.shadow,alignSelf:"flex-start"}}>
        {loading?"Stop":"Scan"}
      </button>
    </div>
  );
}

/* ‚îÄ‚îÄ Copy button ‚îÄ‚îÄ */
function CopyButton({text,label,variant="default"}){
  const[copied,setCopied]=useState(false);
  const copy=async()=>{try{await navigator.clipboard.writeText(text)}catch{const t=document.createElement('textarea');t.value=text;document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t)}setCopied(true);setTimeout(()=>setCopied(false),2000)};
  const s={default:{bg:C.bgAlt,b:C.cardBorder,c:C.textSec,h:"#E8E6DE"},accent:{bg:C.accentSoft,b:C.accentBorder,c:C.accent,h:"rgba(217,119,87,0.15)"},green:{bg:C.greenSoft,b:C.greenBorder,c:C.green,h:"rgba(46,125,91,0.15)"}}[variant]||{bg:C.bgAlt,b:C.cardBorder,c:C.textSec,h:"#E8E6DE"};
  return(
    <button onClick={copy} onMouseEnter={e=>e.currentTarget.style.background=s.h} onMouseLeave={e=>e.currentTarget.style.background=s.bg}
      style={{padding:"4px 10px",borderRadius:"6px",border:`1px solid ${s.b}`,background:s.bg,color:s.c,fontSize:11,fontWeight:600,cursor:"pointer",fontFamily:C.sans,whiteSpace:"nowrap",animation:copied?"_copyFlash 0.3s ease":"none",display:"inline-flex",alignItems:"center",gap:4}}>
      {copied?(<React.Fragment><svg width="12" height="12" viewBox="0 0 16 16" fill="none"><path d="M3 8.5L6.5 12L13 4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>Copied!</React.Fragment>)
      :(<React.Fragment><svg width="12" height="12" viewBox="0 0 16 16" fill="none"><rect x="5" y="5" width="9" height="9" rx="1.5" stroke="currentColor" strokeWidth="1.5"/><path d="M3 11V3C3 2.44772 3.44772 2 4 2H11" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/></svg>{label||"Copy"}</React.Fragment>)}
    </button>
  );
}

/* ‚îÄ‚îÄ Small components ‚îÄ‚îÄ */
function Pill({variant,children}){const s={red:{bg:C.redSoft,c:C.red,b:C.redBorder},green:{bg:C.greenSoft,c:C.green,b:C.greenBorder},amber:{bg:C.amberSoft,c:C.amber,b:C.amberBorder},blue:{bg:C.blueSoft,c:C.blue,b:C.blueBorder},muted:{bg:C.bgAlt,c:C.muted,b:C.cardBorder}}[variant]||{bg:C.bgAlt,c:C.muted,b:C.cardBorder};return<span style={{display:"inline-block",padding:"3px 10px",borderRadius:"999px",fontSize:"11px",fontWeight:600,letterSpacing:"0.01em",color:s.c,background:s.bg,border:`1px solid ${s.b}`,whiteSpace:"nowrap"}}>{children}</span>}
function Stat({value,label,variant}){const color={accent:C.accent,red:C.red,green:C.green,amber:C.amber,muted:C.muted}[variant]||C.text;return(<div style={{background:C.card,borderRadius:C.radius,padding:"16px 12px",textAlign:"center",border:`1px solid ${C.cardBorder}`,boxShadow:C.shadow}}><div style={{fontSize:28,fontWeight:700,color,fontFamily:C.serif,lineHeight:1}}>{value}</div><div style={{fontSize:10,color:C.muted,marginTop:6,textTransform:"uppercase",letterSpacing:"0.06em",fontWeight:600}}>{label}</div></div>)}
function Spinner({text}){return<div style={{display:"flex",alignItems:"center",gap:10,padding:"10px 0"}}><div style={{width:16,height:16,border:`2px solid ${C.accent}`,borderTopColor:"transparent",borderRadius:"50%",animation:"_sp .7s linear infinite"}}/><span style={{color:C.textSec,fontSize:13}}>{text}</span></div>}
function TabBtn({active,children,onClick}){return<button onClick={onClick} style={{padding:"10px 20px",border:"none",cursor:"pointer",fontSize:14,fontWeight:600,fontFamily:C.sans,background:"transparent",color:active?C.accent:C.muted,borderBottom:active?`2px solid ${C.accent}`:"2px solid transparent",borderRadius:0}}>{children}</button>}
function EditIcon(){return<svg width="14" height="14" viewBox="0 0 16 16" fill="none" style={{flexShrink:0}}><path d="M11.5 1.5L14.5 4.5L5 14H2V11L11.5 1.5Z" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M9.5 3.5L12.5 6.5" stroke="currentColor" strokeWidth="1.5"/></svg>}
function ErrorMsg({msg}){return<div style={{background:C.redSoft,border:`1px solid ${C.redBorder}`,borderRadius:C.radiusSm,padding:"12px 16px",color:C.red,marginBottom:16,fontSize:13,lineHeight:1.5}}>{msg}</div>}

/* ‚îÄ‚îÄ Wayback 503 Notice ‚îÄ‚îÄ */
function WaybackNotice(){
  const[dismissed,setDismissed]=useState(false);
  if(dismissed)return null;
  return(
    <div style={{background:C.amberSoft,border:`1px solid ${C.amberBorder}`,borderRadius:C.radius,padding:"14px 18px",marginBottom:18,position:"relative"}}>
      <button onClick={()=>setDismissed(true)} style={{position:"absolute",top:10,right:12,background:"none",border:"none",color:C.mutedLight,cursor:"pointer",fontSize:16,lineHeight:1,padding:4}} title="Dismiss">√ó</button>
      <div style={{display:"flex",gap:10,alignItems:"flex-start"}}>
        <span style={{fontSize:18,lineHeight:1,flexShrink:0,marginTop:1}}>‚ö†Ô∏è</span>
        <div>
          <div style={{fontWeight:700,fontSize:13,color:C.amber,marginBottom:4}}>Wayback Machine links may show "503 Service Unavailable"</div>
          <div style={{fontSize:12,color:C.textSec,lineHeight:1.65}}>
            This is an <strong>Internet Archive server-side issue</strong>, not a problem with this tool or the archived page itself. The Internet Archive serves billions of pages and their servers occasionally return 503 errors under heavy load or during maintenance. <strong>This tool automatically retries failed requests up to 3 times</strong>, but if a Wayback link still shows 503 when you click it, simply refresh ‚Äî the archived content is still there, it's just a temporary capacity bottleneck on their end.
          </div>
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ Scan Engine ‚îÄ‚îÄ */
function useScanEngine(){
  const[results,setResults]=useState([]);const[loading,setLoading]=useState(false);const[progress,setProgress]=useState("");const[error,setError]=useState("");const[done,setDone]=useState(false);const abort=useRef(false);const affectedCount=useRef(0);
  const reset=()=>{setResults([]);setError("");setDone(false);setProgress("");affectedCount.current=0};
  const scanArticles=useCallback(async(titles,{append=false}={})=>{
    setLoading(true);setError("");if(!append){setResults([]);affectedCount.current=0}setDone(false);if(!append)abort.current=false;
    let newHits=0;
    try{for(let ti=0;ti<titles.length;ti++){if(abort.current)break;const title=titles[ti];setProgress(`Scanning ${append?"(extended) ":""}${ti+1} of ${titles.length}: ${title}`);
      let wikitext;try{wikitext=await fetchWikitext(title)}catch(e){setResults(p=>[...p,{title,links:[],error:e.message}]);continue}
      const matches=[...new Set((wikitext.match(AT_RE)||[]).map(u=>u.replace(/[\]|}<>]+$/,"")))];
      const links=matches.map(url=>({archiveUrl:url,originalUrl:extractOriginalUrl(url, wikitext),waybackUrl:null,waybackDate:null,status:"pending"}));      
      if(links.length>0){newHits++;affectedCount.current++}
      const artResult={title,wikitext,links:[...links]};setResults(p=>[...p,artResult]);
      for(let li=0;li<links.length;li++){if(abort.current)break;const lk=links[li];
        if(lk.originalUrl){setProgress(`Scanning ${append?"(extended) ":""}${ti+1} of ${titles.length}: ${title} ‚Äî Wayback (${li+1}/${links.length})`);const wb=await checkWayback(lk.originalUrl);lk.waybackUrl=wb;lk.waybackDate=extractWaybackDate(wb);lk.status=wb?"found":"notfound"}else{lk.status="noextract"}
        setResults(p=>{const u=[...p];const idx=u.findIndex(r=>r.title===title);if(idx!==-1)u[idx]={...artResult,links:[...links]};return u});await new Promise(r=>setTimeout(r,300))}
      links.forEach(l=>{if(l.status==="pending")l.status="noextract"});
      setResults(p=>{const u=[...p];const idx=u.findIndex(r=>r.title===title);if(idx!==-1)u[idx]={...artResult,links:[...links]};return u})
    }}catch(e){setError(e.message)}finally{setLoading(false);setDone(true);setProgress("")}
    return{newHits,totalAffected:affectedCount.current};
  },[]);
  return{results,loading,progress,error,done,scanArticles,stop:()=>{abort.current=true},reset,affectedCount};
}

/* ‚îÄ‚îÄ Results View ‚îÄ‚îÄ */
function ResultsView({results,done,showOnlyAffected=false}){
  const[filter,setFilter]=useState("all");
  // State stages: 0 = locked, 1 = counting down, 2 = ready, 3 = added to queue
  const[linkStates,setLinkStates]=useState({});
  
  if(!results.length&&done)return<div style={{textAlign:"center",color:C.muted,padding:48,fontSize:14}}>No results found.</div>;
  if(!results.length)return null;
  const affected=results.filter(r=>r.links.length>0),clean=results.filter(r=>r.links.length===0);
  const totalLinks=results.reduce((s,r)=>s+r.links.length,0);
  const withAlts=results.reduce((s,r)=>s+r.links.filter(l=>l.waybackUrl).length,0);
  const noAlts=results.reduce((s,r)=>s+r.links.filter(l=>l.status==="notfound").length,0);
  const pending=results.reduce((s,r)=>s+r.links.filter(l=>l.status==="pending").length,0);

  // Split affected articles into fixable (has at least one Wayback alt) vs unfixable (none)
  const fixable = affected.filter(r => r.links.some(l => l.waybackUrl));
  const unfixable = affected.filter(r => !r.links.some(l => l.waybackUrl));

  // Sort fixable: most alternatives first
  const fixableSorted = [...fixable].sort((a, b) => {
    const aAlts = a.links.filter(l => l.waybackUrl).length;
    const bAlts = b.links.filter(l => l.waybackUrl).length;
    return bAlts - aAlts;
  });

  // Determine which articles to display based on filter
  let display;
  if (showOnlyAffected) {
    if (filter === "fixable") display = fixableSorted;
    else if (filter === "unfixable") display = unfixable;
    else if (filter === "clean") display = clean;
    else display = [...fixableSorted, ...unfixable]; // "all" ‚Äî fixable first
  } else {
    if (filter === "affected") display = [...fixableSorted, ...unfixable];
    else if (filter === "clean") display = clean;
    else display = [...fixableSorted, ...unfixable, ...clean]; // "all"
  }

  // 5-Second Countdown Logic
  const handleVerifyClick=(id)=>{
    setLinkStates(p=>{
      if(p[id] && p[id].stage > 0) return p; 
      
      let ticks = 5;
      const iv = setInterval(()=>{
        ticks--;
        if(ticks <= 0){
          clearInterval(iv);
          setLinkStates(prev=>({...prev, [id]: {...prev[id], stage: 2}})); 
        } else {
          setLinkStates(prev=>({...prev, [id]: {...prev[id], stage: 1, timer: ticks}})); 
        }
      }, 1000);
      
      return {...p, [id]: {...p[id], stage: 1, timer: 5}}; 
    });
  };

  const toggleQueue=(id)=>{
    setLinkStates(p=>({...p,[id]:{...p[id],stage:p[id].stage===2?3:2}}));
  };

  return(
    <div style={{animation:"_fadeIn .3s ease"}}>
      {withAlts>0&&(
        <div style={{background:C.blueSoft,border:`1px solid ${C.blueBorder}`,borderRadius:C.radius,padding:"16px 20px",marginBottom:16}}>
          <div style={{fontWeight:700,marginBottom:8,display:"flex",alignItems:"center",gap:6,fontSize:13,color:C.blue}}><EditIcon/> How to fix articles (Assisted Validation)</div>
          <div style={{color:C.textSec,fontSize:12,lineHeight:1.8}}>
            <strong>1.</strong> Click the green <strong>Wayback Machine</strong> links to verify the snapshot. Wait 5 seconds.<br/>
            <strong>2.</strong> Click the blue <strong>Verified</strong> button to stage your fix.<br/>
            <strong>3.</strong> Click <strong style={{color:C.accent}}>Push Verified Archives to Wikipedia</strong> to open the editor with your verified changes pre-applied.
          </div>
        </div>
      )}

      {withAlts>0&&<WaybackNotice/>}

      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(110px, 1fr))",gap:10,marginBottom:24}}>
        <Stat value={results.length} label="Scanned" variant="muted"/><Stat value={affected.length} label="Affected" variant="red"/>
        <Stat value={totalLinks} label="AT Links" variant="amber"/><Stat value={withAlts} label="Alternatives" variant="green"/>
        <Stat value={noAlts} label="No Alt" variant="red"/>{pending>0&&<Stat value={pending} label="Pending" variant="amber"/>}
      </div>

      <div style={{display:"flex",gap:6,marginBottom:18,flexWrap:"wrap"}}>
        {showOnlyAffected ? (
          <React.Fragment>
            <button onClick={()=>setFilter("all")} style={{padding:"6px 16px",borderRadius:"999px",border:`1px solid ${filter==="all"?C.accent:C.cardBorder}`,cursor:"pointer",fontSize:12,fontWeight:600,fontFamily:C.sans,background:filter==="all"?C.accentSoft:C.card,color:filter==="all"?C.accent:C.muted}}>
              All affected ({affected.length})
            </button>
            {fixable.length > 0 && (
              <button onClick={()=>setFilter("fixable")} style={{padding:"6px 16px",borderRadius:"999px",border:`1px solid ${filter==="fixable"?C.green:C.cardBorder}`,cursor:"pointer",fontSize:12,fontWeight:600,fontFamily:C.sans,background:filter==="fixable"?"rgba(46,125,91,0.08)":C.card,color:filter==="fixable"?C.green:C.muted}}>
                ‚úì Fixable ({fixable.length})
              </button>
            )}
            {unfixable.length > 0 && (
              <button onClick={()=>setFilter("unfixable")} style={{padding:"6px 16px",borderRadius:"999px",border:`1px solid ${filter==="unfixable"?C.red:C.cardBorder}`,cursor:"pointer",fontSize:12,fontWeight:600,fontFamily:C.sans,background:filter==="unfixable"?C.redSoft:C.card,color:filter==="unfixable"?C.red:C.muted}}>
                ‚úó No alternative ({unfixable.length})
              </button>
            )}
            <button onClick={()=>setFilter("clean")} style={{padding:"6px 16px",borderRadius:"999px",border:`1px solid ${filter==="clean"?C.accent:C.cardBorder}`,cursor:"pointer",fontSize:12,fontWeight:600,fontFamily:C.sans,background:filter==="clean"?C.accentSoft:C.card,color:filter==="clean"?C.accent:C.muted}}>
              Clean ({clean.length})
            </button>
          </React.Fragment>
        ) : (
          [{v:"all",l:`All (${results.length})`},{v:"affected",l:`Affected (${affected.length})`},{v:"clean",l:`Clean (${clean.length})`}].map(f=>
            <button key={f.v} onClick={()=>setFilter(f.v)} style={{padding:"6px 16px",borderRadius:"999px",border:`1px solid ${filter===f.v?C.accent:C.cardBorder}`,cursor:"pointer",fontSize:12,fontWeight:600,fontFamily:C.sans,background:filter===f.v?C.accentSoft:C.card,color:filter===f.v?C.accent:C.muted}}>{f.l}</button>
          )
        )}
      </div>

      {display.map((art,i)=>(
        <div key={art.title+i} style={{background:C.card,borderRadius:C.radius,padding:"20px 22px",marginBottom:14,border:`1px solid ${C.cardBorder}`,boxShadow:C.shadow,animation:"_fadeIn .25s ease"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:8}}>
            <a href={`https://en.wikipedia.org/wiki/${encodeURIComponent(art.title)}`} target="_blank" rel="noopener noreferrer"
              style={{color:C.text,textDecoration:"none",fontSize:15,fontWeight:600}}
              onMouseEnter={e=>e.currentTarget.style.color=C.accent} onMouseLeave={e=>e.currentTarget.style.color=C.text}>
              {art.title}
            </a>
            <div style={{display:"flex",gap:6,flexWrap:"wrap",alignItems:"center"}}>
              {art.error?(<Pill variant="red">API Error: {art.error}</Pill>):art.links.length>0?(<React.Fragment><Pill variant="red">{art.links.length} archive.today</Pill>{art.links.filter(l=>l.waybackUrl).length>0&&<Pill variant="green">{art.links.filter(l=>l.waybackUrl).length} alt{art.links.filter(l=>l.waybackUrl).length>1?"s":""}</Pill>}</React.Fragment>):(<Pill variant="green">Clean</Pill>)}
            </div>
          </div>

          {art.links.filter(l=>l.waybackUrl).length>0&&(
            <div style={{marginTop:12,display:"flex",gap:8,flexWrap:"wrap",alignItems:"center"}}>
              <button onClick={()=>{
                // Inject the user's custom URL/Date if they edited it
                const linksToFix = art.links.filter(l => {
                    const id = `${art.title}|${l.archiveUrl}`;
                    return l.waybackUrl && linkStates[id]?.stage === 3;
                }).map(l => {
                    const id = `${art.title}|${l.archiveUrl}`;
                    const st = linkStates[id] || {};
                    return {
                        ...l,
                        waybackUrl: st.customUrl || l.waybackUrl,
                        waybackDate: st.customUrl ? st.customDate : l.waybackDate
                    };
                });
                executeMassEdit(art.title, art.wikitext, linksToFix);
              }}
                onMouseEnter={e=>e.currentTarget.style.background=C.accentHover} onMouseLeave={e=>e.currentTarget.style.background=C.accent}
                style={{display:"inline-flex",alignItems:"center",gap:6,padding:"8px 16px",borderRadius:C.radiusSm,border:"none",background:C.accent,color:"#fff",fontSize:13,fontWeight:600,cursor:"pointer",fontFamily:C.sans,boxShadow:C.shadow}}>
                <EditIcon/> Push Verified Archives to Wikipedia
              </button>
              <span style={{fontSize:11,color:C.mutedLight}}>Opens editor with pre-applied fixes</span>
            </div>
          )}

          {art.links.length>0&&(
            <div style={{marginTop:14}}>
              {art.links.map((lk,li)=>{
                const id=`${art.title}|${lk.archiveUrl}`;
                const lState = linkStates[id]||{stage:0};
                const displayUrl = lState.customUrl || lk.waybackUrl;
                const displayDate = lState.customUrl ? lState.customDate : lk.waybackDate;

                return(
                <div key={li} style={{background:C.bgAlt,borderRadius:C.radiusSm,padding:"14px 16px",marginBottom:8,borderLeft:`3px solid ${lk.waybackUrl?C.green:lk.status==="pending"?C.amber:C.red}`}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:6}}>
                    <div style={{flex:1,minWidth:0,display:"flex",gap:12,alignItems:"flex-start"}}>
                      {lk.waybackUrl && (
                        <div style={{marginTop: 4}}>
                          <button 
                            title="Verify new archive URL before selecting"
                            disabled={lState.stage < 2}
                            onClick={()=>toggleQueue(id)}
                            style={{
                              padding: "8px 14px",
                              borderRadius: "6px",
                              fontWeight: "bold",
                              fontSize: "12px",
                              cursor: lState.stage < 2 ? "not-allowed" : "pointer",
                              border: "none",
                              transition: "all 0.1s ease",
                              background: lState.stage === 0 ? "#e2e8f0" : lState.stage === 1 ? "#fef08a" : lState.stage === 2 ? C.accent : C.green,
                              color: lState.stage === 0 ? "#94a3b8" : lState.stage === 1 ? "#854d0e" : "#fff",
                              boxShadow: lState.stage === 2 ? `0 4px 0 ${C.accentHover}` : lState.stage === 3 ? "0 0px 0 transparent" : "none",
                              transform: lState.stage === 3 ? "translateY(4px)" : "translateY(0)"
                            }}>
                            {lState.stage === 0 ? "Verified?" : lState.stage === 1 ? `Wait ${lState.timer}s...` : lState.stage === 2 ? "Verified?" : "Verified ‚úì"}
                          </button>
                        </div>
                      )}
                      <div>
                        <div style={{fontSize:10,color:C.muted,fontFamily:C.mono,marginBottom:4,textTransform:"uppercase",letterSpacing:"0.04em",fontWeight:500}}>Archive.today link #{li+1}</div>
                        <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"}}>
                          <a href={lk.archiveUrl} target="_blank" rel="noopener noreferrer" style={{color:C.red,fontSize:12,wordBreak:"break-all",fontFamily:C.mono,fontWeight:500, textDecoration: lState.stage === 3 ? "line-through" : "none"}}>{lk.archiveUrl}</a>
                          <CopyButton text={lk.archiveUrl} label="Copy old URL"/>
                        </div>
                        {lk.originalUrl&&(<div style={{marginTop:6}}><span style={{color:C.mutedLight,fontSize:10,fontFamily:C.mono}}>Original ‚Üí </span><a href={lk.originalUrl} target="_blank" rel="noopener noreferrer" style={{color:C.muted,fontSize:11,wordBreak:"break-all",fontFamily:C.mono}}>{lk.originalUrl}</a></div>)}
                      </div>
                    </div>
                    {lk.status==="pending"?<Pill variant="amber">Pending</Pill>:lk.status==="found"?<Pill variant="green">Alt found</Pill>:lk.status==="notfound"?<Pill variant="red">No alt</Pill>:<Pill variant="muted">Can't extract</Pill>}
                  </div>
                  {lk.waybackUrl&&(
                    <div style={{marginTop:10,padding:"10px 14px",background:C.greenSoft,borderRadius:C.radiusSm,border:`1px solid ${C.greenBorder}`,opacity:lState.stage === 3?0.5:1,transition:"opacity 0.2s"}}>
                      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:6}}>
                        <div style={{flex:1,minWidth:0}}>
                          <div style={{fontSize:10,color:C.green,fontWeight:600,marginBottom:4,textTransform:"uppercase",letterSpacing:"0.04em"}}>
                            Wayback Machine alternative
                            {!lState.editMode && lState.stage !== 3 && (
                                <span onClick={()=>setLinkStates(p=>({...p, [id]: {...p[id], editMode:true}}))} style={{cursor:"pointer", marginLeft:8, fontSize:10, color:C.accent, textTransform:"none"}}>‚úèÔ∏è Edit</span>
                            )}
                          </div>
                          
                          {lState.editMode ? (
                             <div style={{display:"flex", gap:6, marginTop:4, alignItems:"center"}}>
                               <input id={`edit-${li}`} type="text" defaultValue={displayUrl} style={{flex:1, padding:"4px 8px", fontSize:12, borderRadius:4, border:`1px solid ${C.greenBorder}`}} />
                               <button onClick={()=>{
                                   const val = document.getElementById(`edit-${li}`).value.trim();
                                   let newDate = null;
                                   const dMatch = val.match(/\/web\/(\d{14})/);
                                   if(dMatch) {
                                       const d = dMatch[1];
                                       newDate = `${d.substring(0,4)}-${d.substring(4,6)}-${d.substring(6,8)}`;
                                   }
                                   // Reset stage to 0 to force re-verification of the new URL
                                   setLinkStates(p=>({...p, [id]: {...p[id], editMode:false, customUrl:val, customDate:newDate, stage:0}}));
                               }} style={{padding:"4px 8px", background:C.accent, color:"#fff", border:"none", borderRadius:4, cursor:"pointer", fontSize:11, fontWeight:"bold"}}>Save</button>
                               <button onClick={()=>setLinkStates(p=>({...p, [id]: {...p[id], editMode:false}}))} style={{padding:"4px 8px", background:"transparent", color:C.muted, border:"none", cursor:"pointer", fontSize:11}}>Cancel</button>
                             </div>
                          ) : (
                             <a href={displayUrl} target="_blank" rel="noopener noreferrer" onClick={()=>handleVerifyClick(id)} style={{color:C.green,fontSize:12,wordBreak:"break-all",fontFamily:C.mono,fontWeight:500}} title="Click to open and verify this snapshot">{displayUrl}</a>
                          )}

                        </div>
                        <CopyButton text={displayUrl} label="Copy new URL" variant="green"/>
                      </div>
                      {displayDate&&(
                        <div style={{marginTop:8,paddingTop:8,borderTop:`1px solid ${C.greenBorder}`,display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:6}}>
                          <div>
                            <span style={{fontSize:10,color:C.green,fontWeight:600,textTransform:"uppercase",letterSpacing:"0.04em"}}>Archive-date ‚Üí </span>
                            <code style={{fontSize:12,color:C.green,fontFamily:C.mono,fontWeight:600,background:"rgba(46,125,91,0.1)",padding:"2px 6px",borderRadius:4}}>{displayDate}</code>
                            <span style={{fontSize:10,color:C.muted,marginLeft:6}}>Will map to <code style={{fontSize:10,fontFamily:C.mono}}>|archive-date=</code></span>
                          </div>
                          <CopyButton text={displayDate} label="Copy date" variant="green"/>
                        </div>
                      )}
                      {lState.stage === 3 && (
                        <div style={{marginTop:8,paddingTop:8,borderTop:`1px solid ${C.greenBorder}`}}>
                          <button onClick={()=>{
                            const st = linkStates[id] || {};
                            const singleLink = [{
                              ...lk,
                              waybackUrl: st.customUrl || lk.waybackUrl,
                              waybackDate: st.customUrl ? st.customDate : lk.waybackDate
                            }];
                            executeMassEdit(art.title, art.wikitext, singleLink);
                          }}
                            onMouseEnter={e=>e.currentTarget.style.background=C.accentHover}
                            onMouseLeave={e=>e.currentTarget.style.background=C.accent}
                            style={{display:"inline-flex",alignItems:"center",gap:6,padding:"6px 12px",borderRadius:C.radiusSm,border:"none",background:C.accent,color:"#fff",fontSize:11,fontWeight:600,cursor:"pointer",fontFamily:C.sans}}>
                            <EditIcon/> Fix this link on Wikipedia
                          </button>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )})}
            </div>
          )}
        </div>
      ))}
    </div>
  );
}

/* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
function ArticleTab(){
  const[input,setInput]=useState("");const engine=useScanEngine();
  const go=()=>{if(input.trim())engine.scanArticles([input.trim()])};
  return(
    <React.Fragment>
      <AutocompleteInput placeholder="Search for a Wikipedia article‚Ä¶" value={input} onChange={setInput} onGo={go} loading={engine.loading} onStop={engine.stop} searchFn={searchArticles}/>
      {engine.progress&&<Spinner text={engine.progress}/>}{engine.error&&<ErrorMsg msg={engine.error}/>}
      <ResultsView results={engine.results} done={engine.done}/>
    </React.Fragment>
  );
}

function CategoryTab(){
  const[input,setInput]=useState("");const engine=useScanEngine();
  const go=async()=>{if(!input.trim())return;engine.reset();try{const seen=new Set();let totalAffected=0;let round=0;const MAX_ROUNDS=10;const cat=input.trim();
    while(totalAffected<5&&round<MAX_ROUNDS){round++;const t=await fetchCatMembers(cat,500);const fresh=t.filter(x=>!seen.has(x));fresh.forEach(x=>seen.add(x));if(!fresh.length)break;
    const r=await engine.scanArticles(fresh,{append:round>1});totalAffected=r.totalAffected}}catch(e){}};
  return(
    <React.Fragment>
      <AutocompleteInput placeholder="Search for a Wikipedia category‚Ä¶" value={input} onChange={setInput} onGo={go} loading={engine.loading} onStop={engine.stop} searchFn={searchCategories}/>
      {engine.progress&&<Spinner text={engine.progress}/>}{engine.error&&<ErrorMsg msg={engine.error}/>}
      <ResultsView results={engine.results} done={engine.done}/>
    </React.Fragment>
  );
}

function TopicTab(){
  const[selectedTopic,setSelectedTopic]=useState(null);const[customCats,setCustomCats]=useState("");const[phase,setPhase]=useState("pick");const[gatherProgress,setGatherProgress]=useState("");const engine=useScanEngine();

  // Pick a random subset of categories from the topic each scan
  function pickRandomCats(allCats, count) {
    const shuffled = [...allCats];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled.slice(0, Math.min(count, shuffled.length));
  }

  const startScan=async(allCats)=>{engine.reset();setPhase("gathering");setGatherProgress("Gathering articles‚Ä¶");
    try{const seen=new Set();let totalAffected=0;let round=0;const MAX_ROUNDS=10;
      while(totalAffected<5&&round<MAX_ROUNDS){round++;
        // Each round picks a fresh random subset of categories
        const cats = pickRandomCats(allCats, Math.min(8, allCats.length));
        const all=[];for(let i=0;i<cats.length&&all.length<500;i++){setGatherProgress(`${round>1?`Round ${round}: `:""}Category ${i+1}/${cats.length}: ${cats[i]} (${all.length} articles)`);const m=await fetchCatMembers(cats[i],500-all.length);for(const t of m){if(!seen.has(t)&&all.length<500){seen.add(t);all.push(t)}}}
      if(!all.length)break;setGatherProgress("");setPhase("scanning");const r=await engine.scanArticles(all,{append:round>1});totalAffected=r.totalAffected;
      if(totalAffected<5&&round<MAX_ROUNDS){setPhase("gathering");setGatherProgress(`Found ${totalAffected} affected article${totalAffected!==1?"s":""} so far (need 5). Fetching more‚Ä¶`)}}
      setGatherProgress("");setPhase("scanning")}catch(e){setGatherProgress("");setPhase("pick")}};
  const handleTopicSelect=t=>{setSelectedTopic(t);startScan(t.cats)};
  const handleCustom=()=>{const cats=customCats.split("\n").map(s=>s.trim()).filter(Boolean).map(c=>c.startsWith("Category:")?c:`Category:${c}`);if(!cats.length)return;setSelectedTopic({id:"custom",label:"Custom",icon:"‚úèÔ∏è",cats});startScan(cats)};
  const backToPick=()=>{engine.stop();engine.reset();setSelectedTopic(null);setPhase("pick");setGatherProgress("")};

  if(phase==="pick")return(
    <div>
      <div style={{marginBottom:16}}><h3 style={{fontSize:17,fontWeight:700,color:C.text,margin:"0 0 6px",fontFamily:C.serif}}>Choose a topic area</h3><p style={{fontSize:13,color:C.muted,margin:0,lineHeight:1.5}}>Select a predefined topic or define your own categories below.</p></div>
      <div style={{background:C.amberSoft,border:`1px solid ${C.amberBorder}`,borderRadius:C.radiusSm,padding:"12px 16px",marginBottom:20,display:"flex",alignItems:"center",gap:10}}>
        <span style={{fontSize:20,lineHeight:1,flexShrink:0}}>üìã</span>
        <div><span style={{fontWeight:700,fontSize:13,color:C.amber}}>Scans 500 articles per round.</span><span style={{fontSize:12,color:C.textSec,marginLeft:4}}>If fewer than 5 affected articles are found, the scan automatically continues with a new batch of articles (up to 10 rounds). Articles are randomly sampled each time.</span></div>
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(155px, 1fr))",gap:10,marginBottom:28}}>
        {TOPICS.map(t=>(
          <button key={t.id} onClick={()=>handleTopicSelect(t)} onMouseEnter={e=>{e.currentTarget.style.borderColor=C.accent;e.currentTarget.style.boxShadow=C.shadowMd}} onMouseLeave={e=>{e.currentTarget.style.borderColor=C.cardBorder;e.currentTarget.style.boxShadow=C.shadow}}
            style={{background:C.card,border:`1px solid ${C.cardBorder}`,borderRadius:C.radius,padding:"18px 14px",cursor:"pointer",textAlign:"left",color:C.text,fontFamily:C.sans,boxShadow:C.shadow}}>
            <div style={{fontSize:26,marginBottom:8}}>{t.icon}</div><div style={{fontSize:14,fontWeight:600}}>{t.label}</div><div style={{fontSize:11,color:C.mutedLight,marginTop:4}}>{t.cats.length} categories</div>
          </button>))}
      </div>
      <div style={{background:C.card,borderRadius:C.radius,padding:22,border:`1px solid ${C.cardBorder}`,boxShadow:C.shadow}}>
        <h4 style={{margin:"0 0 6px",fontSize:15,fontWeight:700,color:C.text,fontFamily:C.serif}}>Custom categories</h4>
        <p style={{fontSize:12,color:C.muted,margin:"0 0 14px",lineHeight:1.5}}>Enter one Wikipedia category per line (up to 500 articles total).</p>
        <textarea value={customCats} onChange={e=>setCustomCats(e.target.value)} placeholder={"Category:Radiology\nCategory:Medical imaging\nCategory:Nuclear medicine"} rows={4} style={{width:"100%",boxSizing:"border-box",padding:"12px 14px",borderRadius:C.radiusSm,border:`1px solid ${C.cardBorder}`,background:C.bg,color:C.text,fontSize:13,fontFamily:C.mono,resize:"vertical"}}/>
        <button onClick={handleCustom} disabled={!customCats.trim()} onMouseEnter={e=>{if(customCats.trim())e.currentTarget.style.background=C.btnDarkHover}} onMouseLeave={e=>{e.currentTarget.style.background=C.btnDark}}
          style={{marginTop:12,padding:"10px 24px",borderRadius:C.radiusSm,border:"none",background:C.btnDark,color:"#FAF9F5",fontSize:13,fontWeight:600,cursor:"pointer",fontFamily:C.sans,opacity:customCats.trim()?1:0.35}}>Scan custom categories</button>
      </div>
    </div>
  );

  return(
    <div>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:18,flexWrap:"wrap",gap:10}}>
        <div style={{display:"flex",alignItems:"center",gap:10}}>
          <button onClick={backToPick} onMouseEnter={e=>e.currentTarget.style.borderColor=C.accent} onMouseLeave={e=>e.currentTarget.style.borderColor=C.cardBorder}
            style={{padding:"7px 16px",borderRadius:C.radiusSm,border:`1px solid ${C.cardBorder}`,background:C.card,color:C.muted,fontSize:12,fontWeight:600,cursor:"pointer",fontFamily:C.sans,boxShadow:C.shadow}}>‚Üê Back</button>
          {selectedTopic&&<span style={{fontSize:15,fontWeight:700,color:C.text,fontFamily:C.serif}}>{selectedTopic.icon} {selectedTopic.label}</span>}
          {engine.results.length>0&&<span style={{fontSize:11,color:C.muted,background:C.bgAlt,padding:"4px 10px",borderRadius:"999px",border:`1px solid ${C.cardBorder}`,fontWeight:600}}>{engine.results.length} scanned</span>}
        </div>
        {engine.loading&&<button onClick={()=>{engine.stop();setPhase("scanning")}} style={{padding:"7px 16px",borderRadius:C.radiusSm,border:"none",background:C.red,color:"#fff",fontSize:12,fontWeight:600,cursor:"pointer"}}>Stop scan</button>}
      </div>
      {gatherProgress&&<Spinner text={gatherProgress}/>}{engine.progress&&<Spinner text={engine.progress}/>}{engine.error&&<ErrorMsg msg={engine.error}/>}
      <ResultsView results={engine.results} done={engine.done} showOnlyAffected={true}/>
    </div>
  );
}

/* ‚îÄ‚îÄ High Traffic Tab ‚îÄ‚îÄ */
function HighTrafficTab() {
  const engine = useScanEngine();

  // Default to previous month
  const now = new Date();
  const defaultYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
  const defaultMonth = now.getMonth() === 0 ? 12 : now.getMonth();

  const [year, setYear] = useState(defaultYear);
  const [month, setMonth] = useState(defaultMonth);
  const [phase, setPhase] = useState('pick');
  const [topPages, setTopPages] = useState([]);
  const [fetchError, setFetchError] = useState(null);
  const [fetchProgress, setFetchProgress] = useState('');

  const monthNames = [
    'January','February','March','April','May','June',
    'July','August','September','October','November','December'
  ];

  const startScan = async () => {
    setFetchError(null);
    setPhase('fetching');
    setFetchProgress('Fetching top viewed pages from Wikimedia Pageviews API‚Ä¶');
    engine.reset();

    try {
      const pages = await fetchTopPages(year, month);
      setTopPages(pages);

      if (pages.length === 0) {
        setFetchError('No pages returned from the API for this month.');
        setPhase('pick');
        return;
      }

      setFetchProgress('');
      setPhase('scanning');

      // Scan in batches ‚Äî the API returns ~1000 pages,
      // but we scan up to 500 at a time (existing limit)
      const titles = pages.map(p => p.title);
      const BATCH_SIZE = 500;

      for (let i = 0; i < titles.length; i += BATCH_SIZE) {
        const batch = titles.slice(i, i + BATCH_SIZE);
        await engine.scanArticles(batch, { append: i > 0 });
      }
    } catch (err) {
      setFetchError(err.message || 'Failed to fetch top pages.');
      setPhase('pick');
    }
  };

  const backToPick = () => {
    engine.stop();
    engine.reset();
    setTopPages([]);
    setPhase('pick');
    setFetchProgress('');
    setFetchError(null);
  };

  const currentYear = new Date().getFullYear();
  const yearOptions = [];
  for (let y = currentYear; y >= 2015; y--) {
    yearOptions.push(y);
  }

  if (phase === 'pick') {
    return (
      <div>
        <div style={{ marginBottom: 16 }}>
          <h3 style={{ fontSize: 17, fontWeight: 700, color: C.text, margin: '0 0 6px', fontFamily: C.serif }}>
            Scan high-traffic pages
          </h3>
          <p style={{ color: C.muted, fontSize: 13, margin: 0, lineHeight: 1.55 }}>
            Fetches the top ~1,000 most viewed Wikipedia articles for a given month from the
            {' '}<a href="https://doc.wikimedia.org/generated-data-platform/aqs/analytics-api/reference/page-views.html"
                    target="_blank" rel="noopener noreferrer"
                    style={{ color: C.accent, textDecoration: 'none', fontWeight: 600 }}>
              Wikimedia Pageviews API
            </a>, then scans them for archive.today links.
            This is the same data source used for the
            {' '}<a href="https://en.wikipedia.org/wiki/Wikipedia:Archive.today_guidance/high_traffic_pages_index"
                    target="_blank" rel="noopener noreferrer"
                    style={{ color: C.accent, textDecoration: 'none', fontWeight: 600 }}>
              high-traffic pages index
            </a>.
          </p>
        </div>

        <div style={{
          background: C.card,
          borderRadius: C.radius,
          padding: 22,
          border: `1px solid ${C.cardBorder}`,
          boxShadow: C.shadow
        }}>
          <div style={{ display: 'flex', gap: 12, alignItems: 'flex-end', flexWrap: 'wrap' }}>
            <div>
              <label style={{ display: 'block', fontSize: 11, fontWeight: 600, color: C.muted, marginBottom: 4, textTransform: 'uppercase', letterSpacing: '0.04em' }}>
                Month
              </label>
              <select
                value={month}
                onChange={e => setMonth(Number(e.target.value))}
                style={{
                  padding: '8px 12px', borderRadius: C.radiusSm,
                  border: `1px solid ${C.cardBorder}`, background: C.bg,
                  fontSize: 13, fontFamily: C.sans, color: C.text, cursor: 'pointer'
                }}>
                {monthNames.map((name, i) => (
                  <option key={i + 1} value={i + 1}>{name}</option>
                ))}
              </select>
            </div>

            <div>
              <label style={{ display: 'block', fontSize: 11, fontWeight: 600, color: C.muted, marginBottom: 4, textTransform: 'uppercase', letterSpacing: '0.04em' }}>
                Year
              </label>
              <select
                value={year}
                onChange={e => setYear(Number(e.target.value))}
                style={{
                  padding: '8px 12px', borderRadius: C.radiusSm,
                  border: `1px solid ${C.cardBorder}`, background: C.bg,
                  fontSize: 13, fontFamily: C.sans, color: C.text, cursor: 'pointer'
                }}>
                {yearOptions.map(y => (
                  <option key={y} value={y}>{y}</option>
                ))}
              </select>
            </div>

            <button
              onClick={startScan}
              onMouseEnter={e => e.currentTarget.style.background = C.accentHover}
              onMouseLeave={e => e.currentTarget.style.background = C.accent}
              style={{
                padding: '8px 20px', borderRadius: C.radiusSm,
                border: 'none', background: C.accent, color: '#fff',
                fontSize: 13, fontWeight: 600, cursor: 'pointer',
                fontFamily: C.sans, boxShadow: C.shadow
              }}>
              Scan top pages
            </button>
          </div>

          {fetchError && <ErrorMsg msg={fetchError} />}
        </div>
      </div>
    );
  }

  return (
    <div>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16, flexWrap: 'wrap', gap: 8 }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
          <button
            onClick={backToPick}
            onMouseEnter={e => e.currentTarget.style.borderColor = C.accent}
            onMouseLeave={e => e.currentTarget.style.borderColor = C.cardBorder}
            style={{
              padding: '7px 16px', borderRadius: C.radiusSm,
              border: `1px solid ${C.cardBorder}`, background: C.card,
              color: C.muted, fontSize: 12, fontWeight: 600,
              cursor: 'pointer', fontFamily: C.sans, boxShadow: C.shadow
            }}>
            ‚Üê Back
          </button>
          <span style={{ fontSize: 15, fontWeight: 700, color: C.text, fontFamily: C.serif }}>
            üìà Top pages ‚Äî {monthNames[month - 1]} {year}
          </span>
          {topPages.length > 0 && (
            <span style={{
              fontSize: 11, color: C.muted, background: C.bgAlt,
              padding: '4px 10px', borderRadius: '999px',
              border: `1px solid ${C.cardBorder}`, fontWeight: 600
            }}>
              {topPages.length} pages fetched
            </span>
          )}
        </div>
        {engine.loading && (
          <button
            onClick={() => { engine.stop(); setPhase('scanning'); }}
            style={{
              padding: '7px 16px', borderRadius: C.radiusSm,
              border: 'none', background: C.red, color: '#fff',
              fontSize: 12, fontWeight: 600, cursor: 'pointer'
            }}>
            Stop scan
          </button>
        )}
      </div>

      {fetchProgress && <Spinner text={fetchProgress} />}
      {engine.progress && <Spinner text={engine.progress} />}
      {engine.error && <ErrorMsg msg={engine.error} />}
      <ResultsView results={engine.results} done={engine.done} showOnlyAffected={true} />
    </div>
  );
}

/* ‚îÄ‚îÄ Main App ‚îÄ‚îÄ */
function App(){
  const[tab,setTab]=useState("article");
  return(
    <div style={{minHeight:"100vh",background:C.bg,color:C.text,fontFamily:C.sans}}>
      <header style={{borderBottom:`1px solid ${C.cardBorder}`,padding:"28px 20px 0",textAlign:"center",background:C.card}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:8,marginBottom:8}}>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 2L12 22M2 12H22M4.93 4.93L19.07 19.07M19.07 4.93L4.93 19.07" stroke="#D97757" strokeWidth="2.5" strokeLinecap="round"/></svg>
          <span style={{fontSize:12,color:C.accent,letterSpacing:"0.08em",textTransform:"uppercase",fontWeight:700}}>Wikipedia Reference Audit</span>
        </div>
        <h1 style={{fontFamily:C.serif,fontSize:"clamp(22px,3.5vw,32px)",fontWeight:700,margin:"0 0 6px",color:C.text,lineHeight:1.2}}>Archive.today Link Detector</h1>
        <p style={{color:C.muted,fontSize:13,maxWidth:580,margin:"0 auto 20px",lineHeight:1.55}}>Detect archive.today references in English Wikipedia, find Wayback Machine replacements, and fix them directly.</p>
        <div style={{display:"flex",justifyContent:"center",gap:0,borderTop:`1px solid ${C.cardBorder}`,margin:"0 -20px",padding:"0 20px"}}>
          <TabBtn active={tab==="article"} onClick={()=>setTab("article")}>Article</TabBtn>
          <TabBtn active={tab==="category"} onClick={()=>setTab("category")}>Category</TabBtn>
          <TabBtn active={tab==="topic"} onClick={()=>setTab("topic")}>Topic Browse</TabBtn>
          <TabBtn active={tab==="hightraffic"} onClick={()=>setTab("hightraffic")}>High Traffic</TabBtn>
        </div>
      </header>
      <main style={{maxWidth:880,margin:"0 auto",padding:"24px 20px 48px"}}>{tab==="article"&&<ArticleTab/>}{tab==="category"&&<CategoryTab/>}{tab==="topic"&&<TopicTab/>}{tab==="hightraffic"&&<HighTrafficTab/>}</main>
      <footer style={{maxWidth:880,margin:"0 auto",padding:"0 20px 32px"}}>
        <div style={{padding:"16px 20px",background:C.bgAlt,borderRadius:C.radius,border:`1px solid ${C.cardBorder}`,fontSize:12,color:C.muted,lineHeight:1.8}}>
          <strong style={{color:C.textSec}}>Detected domains:</strong> {AT_DOMAINS.join(", ")}<br/>
          <strong style={{color:C.textSec}}>How it works:</strong> Fetches wikitext ‚Üí regex-matches archive.today URLs ‚Üí extracts original URLs ‚Üí queries Wayback Machine API ‚Üí provides one-click edit links.<br/>
          <strong style={{color:C.textSec}}>Limits:</strong> Up to 500 articles per scan. Wayback checks rate-limited (~300ms between requests). Auto-retries 503 errors up to 3 times with backoff.
        </div>
        <div style={{textAlign:"center",marginTop:16,fontSize:12,color:C.mutedLight}}>
          Created by <a href="https://github.com/nethahussain" target="_blank" rel="noopener noreferrer" style={{color:C.accent,textDecoration:"none",fontWeight:600}} onMouseEnter={e=>e.currentTarget.style.textDecoration="underline"} onMouseLeave={e=>e.currentTarget.style.textDecoration="none"}>Netha Hussain</a> with Claude AI ¬∑ <a href="https://github.com/nethahussain/wikipedia-archive-today-detector" target="_blank" rel="noopener noreferrer" style={{color:C.accent,textDecoration:"none",fontWeight:600}} onMouseEnter={e=>e.currentTarget.style.textDecoration="underline"} onMouseLeave={e=>e.currentTarget.style.textDecoration="none"}>Source code</a>
        </div>
      </footer>
    </div>
  );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
